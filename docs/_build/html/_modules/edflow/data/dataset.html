
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>edflow.data.dataset &#8212; EDFlow  documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">EDFlow  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for edflow.data.dataset</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;All handy dataset classes we use.</span>
<span class="sd">Our Datasets (TODO usually) inherit from the `chainer.dataset.DatasetMixin`.</span>
<span class="sd">Please note that we overwrite the `__getitem__` method.</span>
<span class="sd">This does not change its functionality and there is not problem in not using</span>
<span class="sd">our version of `DatasetMixin`.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="k">import</span> <span class="n">ZipFile</span><span class="p">,</span> <span class="n">ZIP_DEFLATED</span>  <span class="c1"># , ZIP_BZIP2, ZIP_LZMA</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span><span class="p">,</span> <span class="n">trange</span>
<span class="kn">from</span> <span class="nn">chainer.dataset</span> <span class="k">import</span> <span class="n">DatasetMixin</span> <span class="k">as</span> <span class="n">DatasetMixin_</span>
<span class="c1"># TODO maybe just pull</span>
<span class="c1"># https://github.com/chainer/chainer/blob/v4.4.0/chainer/dataset/dataset_mixin.py</span>
<span class="c1"># into the rep to avoid dependency on chainer for this one mixin - it doesnt</span>
<span class="c1"># even do that much and it would provide better documentation as this is</span>
<span class="c1"># actually our base class for datasets</span>

<span class="kn">from</span> <span class="nn">multiprocessing.managers</span> <span class="k">import</span> <span class="n">BaseManager</span>
<span class="kn">import</span> <span class="nn">queue</span>

<span class="kn">from</span> <span class="nn">edflow.main</span> <span class="k">import</span> <span class="n">traceable_method</span><span class="p">,</span> <span class="n">get_implementations_from_config</span>
<span class="kn">from</span> <span class="nn">edflow.util</span> <span class="k">import</span> <span class="n">PRNGMixin</span>


<div class="viewcode-block" id="DatasetMixin"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.DatasetMixin">[docs]</a><span class="k">class</span> <span class="nc">DatasetMixin</span><span class="p">(</span><span class="n">DatasetMixin_</span><span class="p">):</span>
<div class="viewcode-block" id="DatasetMixin.d_msg"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.DatasetMixin.d_msg">[docs]</a>    <span class="k">def</span> <span class="nf">d_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Informs the user that val should be a dict.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="s1">&#39;The edflow version of DatasetMixin requires the &#39;</span> \
               <span class="s1">&#39;`get_example` method to return a `dict`. Yours returned a &#39;</span> \
               <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">))</span></div>

    <span class="nd">@traceable_method</span><span class="p">(</span><span class="n">ignores</span><span class="o">=</span><span class="p">[</span><span class="ne">BrokenPipeError</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="n">ret_dict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">stop</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">step</span> <span class="ow">or</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">),</span> <span class="n">ret_dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_msg</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;index_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ret_dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_msg</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;index_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_msg</span><span class="p">(</span><span class="n">ret_dict</span><span class="p">))</span>

            <span class="n">ret_dict</span><span class="p">[</span><span class="s1">&#39;index_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

        <span class="k">return</span> <span class="n">ret_dict</span></div>


<span class="k">def</span> <span class="nf">make_server_manager</span><span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">63127</span><span class="p">,</span> <span class="n">authkey</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;edcache&quot;</span><span class="p">):</span>
    <span class="n">inqueue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">outqueue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="k">class</span> <span class="nc">InOutManager</span><span class="p">(</span><span class="n">BaseManager</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="n">InOutManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;get_inqueue&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">inqueue</span><span class="p">)</span>
    <span class="n">InOutManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;get_outqueue&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">outqueue</span><span class="p">)</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">InOutManager</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">authkey</span> <span class="o">=</span> <span class="n">authkey</span><span class="p">)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Started manager server at </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">manager</span>


<span class="k">def</span> <span class="nf">make_client_manager</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">63127</span><span class="p">,</span> <span class="n">authkey</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;edcache&quot;</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">InOutManager</span><span class="p">(</span><span class="n">BaseManager</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="n">InOutManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;get_inqueue&quot;</span><span class="p">)</span>
    <span class="n">InOutManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;get_outqueue&quot;</span><span class="p">)</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">InOutManager</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">authkey</span> <span class="o">=</span> <span class="n">authkey</span><span class="p">)</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connected to server at </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">manager</span>


<div class="viewcode-block" id="pickle_and_queue"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.pickle_and_queue">[docs]</a><span class="k">def</span> <span class="nf">pickle_and_queue</span><span class="p">(</span><span class="n">dataset_factory</span><span class="p">,</span>
                     <span class="n">inqueue</span><span class="p">,</span>
                     <span class="n">outqueue</span><span class="p">,</span>
                     <span class="n">naming_template</span><span class="o">=</span><span class="s1">&#39;example_</span><span class="si">{}</span><span class="s1">.p&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Parallelizable function to retrieve and queue examples from a Dataset.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_factory (() -&gt; chainer.DatasetMixin): A dataset factory, with</span>
<span class="sd">            methods described in :class:`CachedDataset`.</span>
<span class="sd">        indeces (list): List of indeces, used to retrieve samples from dataset.</span>
<span class="sd">        queue (mp.Queue): Queue to put the samples in.</span>
<span class="sd">        naming_template (str): Formatable string, which defines the name of</span>
<span class="sd">            the stored file given its index.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">()</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset_factory</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">inqueue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">example</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error getting example </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
                <span class="k">raise</span>
            <span class="n">pickle_name</span> <span class="o">=</span> <span class="n">naming_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">pickle_bytes</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>

            <span class="n">outqueue</span><span class="o">.</span><span class="n">put</span><span class="p">([</span><span class="n">pickle_name</span><span class="p">,</span> <span class="n">pickle_bytes</span><span class="p">])</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">_CacheDataset</span><span class="p">(</span><span class="n">DatasetMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Only used to avoid initializing the original dataset.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="n">zippath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;cached&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s2">&quot;.zip&quot;</span><span class="p">)</span>
        <span class="n">naming_template</span> <span class="o">=</span> <span class="s1">&#39;example_</span><span class="si">{}</span><span class="s1">.p&#39;</span>
        <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">zippath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_f</span><span class="p">:</span>
            <span class="n">zipfilenames</span> <span class="o">=</span> <span class="n">zip_f</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">is_example</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;example_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.p&quot;</span><span class="p">)</span>
        <span class="n">examplefilenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">zipfilenames</span> <span class="k">if</span> <span class="n">is_example</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">examplefilenames</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>


<div class="viewcode-block" id="CachedDataset"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.CachedDataset">[docs]</a><span class="k">class</span> <span class="nc">CachedDataset</span><span class="p">(</span><span class="n">DatasetMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Using a Dataset of single examples creates a cached (saved to memory)</span>
<span class="sd">    version, which can be accessed way faster at runtime.</span>

<span class="sd">    To avoid creating the dataset multiple times, it is checked if the cached</span>
<span class="sd">    version already exists.</span>

<span class="sd">    Calling `__getitem__` on this class will try to retrieve the samples from</span>
<span class="sd">    the cached dataset to reduce the preprocessing overhead.</span>

<span class="sd">    The cached dataset will be stored in the root directory of the base dataset</span>
<span class="sd">    in the subfolder `cached` with name `name.zip`.</span>

<span class="sd">    Besides the usual DatasetMixin interface, datasets to be cached must</span>
<span class="sd">    also implement</span>

<span class="sd">        root        # (str) root folder to cache into</span>
<span class="sd">        name        # (str) unqiue name</span>

<span class="sd">    Optionally but highly recommended, they should provide</span>

<span class="sd">        in_memory_keys  # list(str) keys which will be collected from examples</span>

<span class="sd">    The collected values are stored in a dict of list, mapping an</span>
<span class="sd">    in_memory_key to a list containing the i-ths value at the i-ths place.</span>
<span class="sd">    This data structure is then exposed via the attribute `labels` and</span>
<span class="sd">    enables rapid iteration over useful labels without loading each example</span>
<span class="sd">    seperately. That way, downstream datasets can filter the indices of the</span>
<span class="sd">    cached dataset efficiently, e.g. filtering based on train/eval splits.</span>

<span class="sd">    Caching proceeds as follows:</span>
<span class="sd">    Expose a method which returns the dataset to be cached, e.g.</span>

<span class="sd">        def DataToCache():</span>
<span class="sd">          path = &quot;/path/to/data&quot;</span>
<span class="sd">          return MyCachableDataset(path)</span>

<span class="sd">    Start caching server on host &lt;server_ip_or_hostname&gt;:</span>

<span class="sd">        edcache --server --dataset import.path.to.DataToCache</span>

<span class="sd">    Wake up a worker bee on same or different hosts:</span>

<span class="sd">        edcache --address &lt;server_ip_or_hostname&gt; --dataset import.path.to.DataCache</span>

<span class="sd">    Start a cacherhive!</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">dataset</span><span class="p">,</span>
                 <span class="n">force_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">keep_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Given a dataset class, stores all examples in the dataset, if this</span>
<span class="sd">        has not yet happened.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (object): Dataset class which defines the following</span>
<span class="sd">                methods:</span>
<span class="sd">                    - `root`: returns the path to the raw data</span>
<span class="sd">                    - `name`: returns the name of the dataset -&gt; best be unique</span>
<span class="sd">                    - `__len__`: number of examples in the dataset</span>
<span class="sd">                    - `__getitem__`: returns a sindle datum</span>
<span class="sd">                    - `in_memory_keys`: returns all keys, that are stored</span>
<span class="sd">                        alongside the dataset, in a `labels.p` file. This</span>
<span class="sd">                        allows to retrive labels more quickly and can be used</span>
<span class="sd">                        to filter the data more easily.</span>
<span class="sd">            force_cache (bool): If True the dataset is cached even if an</span>
<span class="sd">                existing, cached version is overwritten.</span>
<span class="sd">            keep_existing (bool): If True, existing entries in cache will</span>
<span class="sd">                not be recomputed and only non existing examples are</span>
<span class="sd">                appended to the cache. Useful if caching was interrupted.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">force_cache</span> <span class="o">=</span> <span class="n">force_cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_existing</span> <span class="o">=</span> <span class="n">keep_existing</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base_dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">root</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">root</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">store_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;cached&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store_dir</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.zip&#39;</span><span class="p">)</span>

        <span class="c1">#leading_zeroes = str(len(str(len(self))))</span>
        <span class="c1">#self.naming_template = &#39;example_{:0&gt;&#39; + leading_zeroes + &#39;}.p&#39;</span>
        <span class="c1"># above might be better, but for compatibility we need this right</span>
        <span class="c1"># now, because pickle_and_queue did not receive the updated template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">naming_template</span> <span class="o">=</span> <span class="s1">&#39;example_</span><span class="si">{}</span><span class="s1">.p&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labels_name</span> <span class="o">=</span> <span class="s1">&#39;labels.p&#39;</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_dataset</span><span class="p">()</span>

<div class="viewcode-block" id="CachedDataset.from_cache"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.CachedDataset.from_cache">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_cache</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use this constructor to avoid initialization of original dataset</span>
<span class="sd">        which can be useful if only the cached zip file is available or to</span>
<span class="sd">        avoid expensive constructors of datasets.&quot;&quot;&quot;</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">_CacheDataset</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close file before pickling.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;zip&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zip</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zip</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentpid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fork_safe_zip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">currentpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_initpid&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="n">currentpid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initpid</span> <span class="o">=</span> <span class="n">currentpid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zip</span> <span class="o">=</span> <span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip</span>

<div class="viewcode-block" id="CachedDataset.cache_dataset"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.CachedDataset.cache_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">cache_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Checks if a dataset is stored. If not iterates over all possible</span>
<span class="sd">        indeces and stores the examples in a file, as well as the labels.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store_path</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_cache</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Caching </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store_path</span><span class="p">))</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">make_server_manager</span><span class="p">()</span>
            <span class="n">inqueue</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_inqueue</span><span class="p">()</span>
            <span class="n">outqueue</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_outqueue</span><span class="p">()</span>

            <span class="n">N_examples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dataset</span><span class="p">)</span>
            <span class="n">indeces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N_examples</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_existing</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_f</span><span class="p">:</span>
                    <span class="n">zipfilenames</span> <span class="o">=</span> <span class="n">zip_f</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
                <span class="n">zipfilenames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">zipfilenames</span><span class="p">)</span>
                <span class="n">indeces</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indeces</span> <span class="k">if</span>
                        <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">naming_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="n">zipfilenames</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Keeping </span><span class="si">{}</span><span class="s2"> cached examples.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N_examples</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">indeces</span><span class="p">)))</span>
                <span class="n">N_examples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indeces</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Caching </span><span class="si">{}</span><span class="s2"> examples.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N_examples</span><span class="p">))</span>
            <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">64</span>
            <span class="n">index_chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">indeces</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunk_size</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">indeces</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">index_chunks</span><span class="p">:</span>
                <span class="n">inqueue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting for results.&quot;</span><span class="p">)</span>

            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">N_examples</span><span class="p">)</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_existing</span> <span class="k">else</span> <span class="s2">&quot;w&quot;</span>
            <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store_path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip</span><span class="p">:</span>
                <span class="n">done_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">done_count</span> <span class="o">==</span> <span class="n">N_examples</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">pickle_name</span><span class="p">,</span> <span class="n">pickle_bytes</span> <span class="o">=</span> <span class="n">outqueue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">zip</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">pickle_name</span><span class="p">,</span> <span class="n">pickle_bytes</span><span class="p">)</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">done_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># after everything is done, we store memory keys seperately for</span>
            <span class="c1"># more efficient access</span>
            <span class="c1"># Note that this is always called, in case one wants to add labels</span>
            <span class="c1"># after caching has finished. This will add a new file with the</span>
            <span class="c1"># same name to the zip and it is currently not possible to delete</span>
            <span class="c1"># the old one. Preliminary tests have shown that the read method</span>
            <span class="c1"># returns the newest file if multiple ones are available but this</span>
            <span class="c1"># is _not_ documented or guaranteed in the API. If you experience</span>
            <span class="c1"># problems, try to write a new zip file with desired contents or</span>
            <span class="c1"># delete cached zip and cache again.</span>
            <span class="n">memory_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dataset</span><span class="p">,</span> <span class="s1">&#39;in_memory_keys&#39;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Caching Labels.&#39;</span><span class="p">)</span>
                <span class="n">memory_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dataset</span><span class="o">.</span><span class="n">in_memory_keys</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">memory_keys</span><span class="p">:</span>
                    <span class="n">memory_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dataset</span><span class="p">)):</span>
                    <span class="n">example</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="c1"># load cached version</span>
                    <span class="c1"># extract keys</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">memory_keys</span><span class="p">:</span>
                        <span class="n">memory_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

            <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipfile</span><span class="p">:</span>
                <span class="n">zipfile</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_labels_name</span><span class="p">,</span>
                        <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">memory_dict</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished caching.&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Number of examples in this Dataset.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dataset</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns the labels associated with the base dataset, but from the</span>
<span class="sd">        cached source.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_labels&quot;</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fork_safe_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_labels_name</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns the root to the base dataset.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span>

<div class="viewcode-block" id="CachedDataset.get_example"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.CachedDataset.get_example">[docs]</a>    <span class="k">def</span> <span class="nf">get_example</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Given an index i, returns a example.&#39;&#39;&#39;</span>

        <span class="n">example_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">naming_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">example_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fork_safe_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">example_name</span><span class="p">)</span>

        <span class="n">example</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">example_file</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">example</span></div></div>


<div class="viewcode-block" id="PathCachedDataset"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.PathCachedDataset">[docs]</a><span class="k">class</span> <span class="nc">PathCachedDataset</span><span class="p">(</span><span class="n">CachedDataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Used for simplified decorator interface to dataset caching.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">dataset</span><span class="p">,</span>
                 <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force_cache</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_existing</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base_dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_path</span> <span class="o">=</span> <span class="n">path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">naming_template</span> <span class="o">=</span> <span class="s1">&#39;example_</span><span class="si">{}</span><span class="s1">.p&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labels_name</span> <span class="o">=</span> <span class="s1">&#39;labels.p&#39;</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lenfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_path</span> <span class="o">+</span> <span class="s2">&quot;.p&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lenfile</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force_cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_dataset</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lenfile</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lenfile</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dataset</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dataset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lenfile</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dataset</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_len&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lenfile</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span></div>


<div class="viewcode-block" id="cachable"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.cachable">[docs]</a><span class="k">def</span> <span class="nf">cachable</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to cache datasets. If not cached, will start a caching server,</span>
<span class="sd">    subsequent calls will just load from cache. Currently all worker must be</span>
<span class="sd">    able to see the path. Be careful, function parameters are ignored on</span>
<span class="sd">    furture calls.</span>
<span class="sd">    Can be used on any callable that returns a dataset. Currently the path</span>
<span class="sd">    should be the path to a zip file to cache into - i.e. it should end in zip.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;.p&quot;</span><span class="p">):</span>
                <span class="c1"># cached version ready</span>
                <span class="k">return</span> <span class="n">PathCachedDataset</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;parameters.p&quot;</span><span class="p">):</span>
                <span class="c1"># zip exists but not pickle with length - caching server</span>
                <span class="c1"># started and we are a worker bee</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;parameters.p&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># start caching server</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;parameters.p&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">((</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">PathCachedDataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapped</span>
    <span class="k">return</span> <span class="n">decorator</span></div>


<div class="viewcode-block" id="SubDataset"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.SubDataset">[docs]</a><span class="k">class</span> <span class="nc">SubDataset</span><span class="p">(</span><span class="n">DatasetMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A subset of a given dataset.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">subindices</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subindices</span> <span class="o">=</span> <span class="n">subindices</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subindices</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expected a list of subindices.&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

<div class="viewcode-block" id="SubDataset.get_example"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.SubDataset.get_example">[docs]</a>    <span class="k">def</span> <span class="nf">get_example</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get example and process. Wrapped to make sure stacktrace is</span>
<span class="sd">        printed in case something goes wrong and we are in a</span>
<span class="sd">        MultiprocessIterator.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">subindices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subindices</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># relay if data is cached</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_labels&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">labels</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subindices</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span></div>


<div class="viewcode-block" id="LabelDataset"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.LabelDataset">[docs]</a><span class="k">class</span> <span class="nc">LabelDataset</span><span class="p">(</span><span class="n">DatasetMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A label only dataset to avoid loading unnecessary data.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<div class="viewcode-block" id="LabelDataset.get_example"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.LabelDataset.get_example">[docs]</a>    <span class="k">def</span> <span class="nf">get_example</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return labels of example.&quot;&quot;&quot;</span>
        <span class="n">example</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">)</span>
        <span class="n">example</span><span class="p">[</span><span class="s2">&quot;base_index_&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">example</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># relay if data is cached</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">labels</span></div>


<div class="viewcode-block" id="ProcessedDataset"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.ProcessedDataset">[docs]</a><span class="k">class</span> <span class="nc">ProcessedDataset</span><span class="p">(</span><span class="n">DatasetMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dataset with data processing applied.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">update</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="o">=</span> <span class="n">update</span>

<div class="viewcode-block" id="ProcessedDataset.get_example"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.ProcessedDataset.get_example">[docs]</a>    <span class="k">def</span> <span class="nf">get_example</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get example and process. Wrapped to make sure stacktrace is</span>
<span class="sd">        printed in case something goes wrong and we are in a</span>
<span class="sd">        MultiprocessIterator.&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">d</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># relay if data is cached</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">labels</span></div>


<div class="viewcode-block" id="ExtraLabelsDataset"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.ExtraLabelsDataset">[docs]</a><span class="k">class</span> <span class="nc">ExtraLabelsDataset</span><span class="p">(</span><span class="n">DatasetMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dataset with extra labels added.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">labeler</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labeler</span> <span class="o">=</span> <span class="n">labeler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_labeler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_new_labels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">new_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labeler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_keys</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_new_labels</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new_labels</span><span class="p">)</span>

<div class="viewcode-block" id="ExtraLabelsDataset.get_example"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.ExtraLabelsDataset.get_example">[docs]</a>    <span class="k">def</span> <span class="nf">get_example</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get example and add new labels.&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_example</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">new_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_labels</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_labels</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_labels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span></div>


<div class="viewcode-block" id="ConcatenatedDataset"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.ConcatenatedDataset">[docs]</a><span class="k">class</span> <span class="nc">ConcatenatedDataset</span><span class="p">(</span><span class="n">DatasetMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dataset which concatenates given datasets.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">datasets</span><span class="p">,</span> <span class="n">balanced</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lengths</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balanced</span> <span class="o">=</span> <span class="n">balanced</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">balanced</span><span class="p">:</span>
            <span class="n">max_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lengths</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">data_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">)):</span>
                <span class="n">data_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">data_idx</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">data_length</span> <span class="o">!=</span> <span class="n">max_length</span><span class="p">:</span>
                    <span class="n">cycle_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">data_length</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_length</span><span class="p">)]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">data_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">SubDataset</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">data_idx</span><span class="p">],</span> <span class="n">cycle_indices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lengths</span><span class="p">)</span>


<div class="viewcode-block" id="ConcatenatedDataset.get_example"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.ConcatenatedDataset.get_example">[docs]</a>    <span class="k">def</span> <span class="nf">get_example</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get example and add dataset index to it.&quot;&quot;&quot;</span>
        <span class="n">did</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">did</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">local_i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundaries</span><span class="p">[</span><span class="n">did</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_i</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">example</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">did</span><span class="p">][</span><span class="n">local_i</span><span class="p">]</span>
        <span class="n">example</span><span class="p">[</span><span class="s2">&quot;dataset_index_&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">did</span>
        <span class="k">return</span> <span class="n">example</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lengths</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># relay if data is cached</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_labels&quot;</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">labels</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">)):</span>
                <span class="n">new_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">labels</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                    <span class="n">labels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">new_labels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span></div>


<div class="viewcode-block" id="ExampleConcatenatedDataset"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.ExampleConcatenatedDataset">[docs]</a><span class="k">class</span> <span class="nc">ExampleConcatenatedDataset</span><span class="p">(</span><span class="n">DatasetMixin</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Concatenates a list of datasets along the example axis.</span>
<span class="sd">    E.g.:</span>
<span class="sd">    dset1 = [{&#39;a&#39;: 1, &#39;b&#39;: 2}, {&#39;a&#39;: 3, &#39;b&#39;: 4}, ...]</span>
<span class="sd">    dset2 = [{&#39;a&#39;: 6, &#39;b&#39;: 7}, {&#39;a&#39;: 8, &#39;b&#39;: 9}, ...]</span>

<span class="sd">    dset_conc = ExampleConcatenatedDataset(dset1, dset2)</span>
<span class="sd">    print(dset_conc[0])</span>
<span class="sd">    # {&#39;a_0&#39;: 1, &#39;a_1&#39;: 6,</span>
<span class="sd">    #  &#39;b_0&#39;: 2, &#39;b_1&#39;: 7,</span>
<span class="sd">    #  &#39;a&#39;: [&#39;a_0&#39;, &#39;a_1&#39;],</span>
<span class="sd">    #  &#39;b&#39;: [&#39;b_0&#39;, &#39;b_1&#39;]}</span>

<span class="sd">    The new keys (e.g. `a_0, a_1`) are numbered in the order they are taken</span>
<span class="sd">    from datasets. Additionally, the original, shared key is preserved and</span>
<span class="sd">    returns the list of newly generated keys in correct order.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">datasets</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Args:</span>
<span class="sd">            *datasets (DatasetMixin): All the datasets to concatenate. Each</span>
<span class="sd">                dataset must return a dict as example!</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_example_pars</span><span class="p">()</span>

<div class="viewcode-block" id="ExampleConcatenatedDataset.set_example_pars"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.ExampleConcatenatedDataset.set_example_pars">[docs]</a>    <span class="k">def</span> <span class="nf">set_example_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Allows to manipulate the length and step of the returned example</span>
<span class="sd">        lists.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">example_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Now each index corresponds to a sequence of labels.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_labels&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="c1"># sometimes numpy arrays or lists are given as labels</span>
                <span class="c1"># their axes stay at the same positions.</span>
                <span class="n">trans</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">*</span><span class="n">trans</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span>

<div class="viewcode-block" id="ExampleConcatenatedDataset.get_example"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.ExampleConcatenatedDataset.get_example">[docs]</a>    <span class="k">def</span> <span class="nf">get_example</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="n">examples</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">example_slice</span><span class="p">]]</span>

        <span class="n">new_examples</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">examples</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ex</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_examples</span><span class="p">:</span>
                    <span class="n">new_examples</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_examples</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">new_examples</span></div></div>


<div class="viewcode-block" id="SequenceDataset"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.SequenceDataset">[docs]</a><span class="k">class</span> <span class="nc">SequenceDataset</span><span class="p">(</span><span class="n">DatasetMixin</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Wraps around a dataset and returns sequences of examples.</span>
<span class="sd">    Given the length of those sequences the number of available examples</span>
<span class="sd">    is reduced by this length times the step taken. Additionally each</span>
<span class="sd">    example must have a frame id `fid`, by which it can be filtered. This is to</span>
<span class="sd">    ensure that each frame is taken from the same video.</span>
<span class="sd">    </span>
<span class="sd">    This class assumes that examples come sequentially with fid and that fid 0</span>
<span class="sd">    exists.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Args:</span>
<span class="sd">            dataset (DatasetMixin): Dataset from which single frame examles</span>
<span class="sd">                are taken.</span>
<span class="sd">            length (int): Length of the returned sequences in frames.</span>
<span class="sd">            step (int): Step between returned frames. Must be `&gt;= 1`.</span>

<span class="sd">        This dataset will have `len(dataset) - length * step` examples.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span>

        <span class="n">frame_ids</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="s1">&#39;fid&#39;</span><span class="p">]</span>
        <span class="n">top_indeces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frame_ids</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">length</span> <span class="o">*</span> <span class="n">step</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">all_subdatasets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span> <span class="o">*</span> <span class="n">step</span><span class="p">):</span>
            <span class="n">indeces</span> <span class="o">=</span> <span class="n">top_indeces</span> <span class="o">-</span> <span class="n">i</span>
            <span class="n">subdset</span> <span class="o">=</span> <span class="n">SubDataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">indeces</span><span class="p">)</span>
            <span class="n">all_subdatasets</span> <span class="o">+=</span> <span class="p">[</span><span class="n">subdset</span><span class="p">]</span>

        <span class="n">all_subdatasets</span> <span class="o">=</span> <span class="n">all_subdatasets</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dset</span> <span class="o">=</span> <span class="n">ExampleConcatenatedDataset</span><span class="p">(</span><span class="o">*</span><span class="n">all_subdatasets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dset</span><span class="o">.</span><span class="n">set_example_pars</span><span class="p">(</span><span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dset</span><span class="o">.</span><span class="n">labels</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dset</span><span class="p">)</span>

<div class="viewcode-block" id="SequenceDataset.get_example"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.SequenceDataset.get_example">[docs]</a>    <span class="k">def</span> <span class="nf">get_example</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Retreives a list of examples starting at i.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="UnSequenceDataset"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.UnSequenceDataset">[docs]</a><span class="k">class</span> <span class="nc">UnSequenceDataset</span><span class="p">(</span><span class="n">DatasetMixin</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Flattened version of a :class:`SequenceDataset`.</span>
<span class="sd">    Adds a new key ``seq_idx`` to each example, corresponding to the sequence</span>
<span class="sd">    index and a key ``example_idx`` corresponding to the original index.</span>
<span class="sd">    The ordering of the dataset is kept and sequence examples are ordererd as</span>
<span class="sd">    in the sequence they are taken from.</span>

<span class="sd">    .. warning:: This will not create the original non-sequence dataset! The</span>
<span class="sd">        new dataset contains ``sequence-length x len(SequenceDataset)``</span>
<span class="sd">        examples.</span>

<span class="sd">    If the original dataset would be represented as a 2d numpy array the </span>
<span class="sd">    ``UnSequence`` version of it would be the concatenation of all its rows:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        a = np.arange(12)</span>
<span class="sd">        seq_dataset = a.reshape([3, 4])</span>
<span class="sd">        unseq_dataset = np.concatenate(seq_dataset, axis=-1)</span>

<span class="sd">        np.all(a == unseq_dataset))  # True</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq_dataset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">seq_dataset</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">length</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># Try to get the seq_length from the labels</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_labels&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">labels</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<div class="viewcode-block" id="UnSequenceDataset.get_example"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.UnSequenceDataset.get_example">[docs]</a>    <span class="k">def</span> <span class="nf">get_example</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="n">example_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span>
        <span class="n">seq_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span>

        <span class="n">example</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">example_idx</span><span class="p">]</span>
        <span class="n">seq_example</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">example</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># index is added by DatasetMixin</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;index_&#39;</span><span class="p">:</span>
                <span class="n">seq_example</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">seq_idx</span><span class="p">]</span>
        <span class="n">seq_example</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;seq_idx&#39;</span><span class="p">:</span> <span class="n">seq_idx</span><span class="p">,</span> <span class="s1">&#39;example_idx&#39;</span><span class="p">:</span> <span class="n">example_idx</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">seq_example</span></div></div>


<div class="viewcode-block" id="getSeqDataset"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.getSeqDataset">[docs]</a><span class="k">def</span> <span class="nf">getSeqDataset</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This allows to not define a dataset class, but use a baseclass and a</span>
<span class="sd">    `length` and `step` parameter in the supplied `config` to load and</span>
<span class="sd">    sequentialize a dataset.</span>

<span class="sd">    A config passed to edflow would the look like this:</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        dataset: edflow.data.dataset.getSeqDataSet</span>
<span class="sd">        model: Some Model</span>
<span class="sd">        iterator: Some Iterator</span>

<span class="sd">        seqdataset:</span>
<span class="sd">                dataset: import.path.to.your.basedataset,</span>
<span class="sd">                length: 3,</span>
<span class="sd">                step: 1}</span>

<span class="sd">    ``getSeqDataSet`` will import the base ``dataset`` and pass it to</span>
<span class="sd">    :class:`SequenceDataset` together with ``length`` and ``step`` to</span>
<span class="sd">    make the actually used dataset.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (dict): An edflow config, with at least the keys</span>
<span class="sd">            ``seqdataset`` and nested inside it ``dataset``, ``seq_length`` and</span>
<span class="sd">            ``seq_step``.</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`SequenceDataset`: A Sequence Dataset based on the basedataset.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">ks</span> <span class="o">=</span> <span class="s1">&#39;seqdataset&#39;</span>
    <span class="n">base_dset</span> <span class="o">=</span> <span class="n">get_implementations_from_config</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">ks</span><span class="p">],</span>
                                                <span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">])[</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span>
    <span class="n">base_dset</span> <span class="o">=</span> <span class="n">base_dset</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SequenceDataset</span><span class="p">(</span><span class="n">base_dset</span><span class="p">,</span>
                           <span class="n">config</span><span class="p">[</span><span class="n">ks</span><span class="p">][</span><span class="s1">&#39;seq_length&#39;</span><span class="p">],</span>
                           <span class="n">config</span><span class="p">[</span><span class="n">ks</span><span class="p">][</span><span class="s1">&#39;seq_step&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="JoinedDataset"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.JoinedDataset">[docs]</a><span class="k">def</span> <span class="nf">JoinedDataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">n_joins</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Concat n_joins random samples based on the condition that</span>
<span class="sd">    example_i[key] == example_j[key] for all i,j. Key must be in labels of</span>
<span class="sd">    dataset.&quot;&quot;&quot;</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="n">unique_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">index_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
        <span class="n">index_map</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">join_indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)))]</span> <span class="c1"># example_0 is original example</span>
    <span class="n">prng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_joins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">prng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">index_map</span><span class="p">[</span><span class="n">value</span><span class="p">])</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
        <span class="n">join_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">SubDataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span> <span class="k">for</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">join_indices</span><span class="p">]</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">ExampleConcatenatedDataset</span><span class="p">(</span><span class="o">*</span><span class="n">datasets</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dataset</span></div>


<div class="viewcode-block" id="getDebugDataset"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.getDebugDataset">[docs]</a><span class="k">def</span> <span class="nf">getDebugDataset</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Loads a dataset from the config and makes ist reasonably small.</span>
<span class="sd">    The config syntax works as in :func:`getSeqDataset`. See there for</span>
<span class="sd">    more extensive documentation.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (dict): An edflow config, with at least the keys</span>
<span class="sd">            ``debugdataset`` and nested inside it ``dataset``,</span>
<span class="sd">            ``debug_length``, defining the basedataset and its size.</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`SubDataset`: A dataset based on the basedataset of the specifed</span>
<span class="sd">            length.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">ks</span> <span class="o">=</span> <span class="s1">&#39;debugdataset&#39;</span>
    <span class="n">base_dset</span> <span class="o">=</span> <span class="n">get_implementations_from_config</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">ks</span><span class="p">],</span>
                                                <span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">])[</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span>
    <span class="n">base_dset</span> <span class="o">=</span> <span class="n">base_dset</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">ks</span><span class="p">][</span><span class="s1">&#39;debug_length&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">SubDataset</span><span class="p">(</span><span class="n">base_dset</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span></div>


<div class="viewcode-block" id="RandomlyJoinedDataset"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.RandomlyJoinedDataset">[docs]</a><span class="k">class</span> <span class="nc">RandomlyJoinedDataset</span><span class="p">(</span><span class="n">DatasetMixin</span><span class="p">,</span> <span class="n">PRNGMixin</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Joins similiar JoinedDataset but randomly selects from possible joins.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">n_joins</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Args:</span>
<span class="sd">            dataset: Dataset to join in.</span>
<span class="sd">            key: Key to join on. Must be in dataset labels.</span>
<span class="sd">            n_joins: Number of examples to join.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_joins</span> <span class="o">=</span> <span class="n">n_joins</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">unique_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Careful this can only give labels of the original item, not the</span>
<span class="sd">        joined ones.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">labels</span>


<div class="viewcode-block" id="RandomlyJoinedDataset.get_example"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.RandomlyJoinedDataset.get_example">[docs]</a>    <span class="k">def</span> <span class="nf">get_example</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="n">example</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">join_value</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>

        <span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_map</span><span class="p">[</span><span class="n">join_value</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">join_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">choices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_joins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">examples</span> <span class="o">=</span> <span class="p">[</span><span class="n">example</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">join_indices</span><span class="p">]</span>

        <span class="n">new_examples</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ex</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_examples</span><span class="p">:</span>
                    <span class="n">new_examples</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_examples</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">new_examples</span></div></div>


<div class="viewcode-block" id="DataFolder"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.DataFolder">[docs]</a><span class="k">class</span> <span class="nc">DataFolder</span><span class="p">(</span><span class="n">DatasetMixin</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Given the root of a possibly nested folder containing datafiles and a</span>
<span class="sd">    Callable that generates the labels to the datafile from its full name, this</span>
<span class="sd">    class creates a labeled dataset.</span>

<span class="sd">    A filtering of unwanted Data can be achieved by having the ``label_fn``</span>
<span class="sd">    return ``None`` for those specific files. The actual files are only</span>
<span class="sd">    read when ``__getitem__`` is called.</span>

<span class="sd">    If for example ``label_fn`` returns a dict with the keys ``[&#39;a&#39;, &#39;b&#39;,</span>
<span class="sd">    &#39;c&#39;]`` and ``read_fn`` returns one with keys ``[&#39;d&#39;, &#39;e&#39;]`` then the dict</span>
<span class="sd">    returned by ``__getitem__`` will contain the keys ``[&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;,</span>
<span class="sd">    &#39;e&#39;, &#39;file_path_&#39;, &#39;index_&#39;]``.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">image_root</span><span class="p">,</span>
                 <span class="n">read_fn</span><span class="p">,</span>
                 <span class="n">label_fn</span><span class="p">,</span>
                 <span class="n">sort_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">in_memory_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Args:</span>
<span class="sd">            image_root (str): Root containing the files of interest.</span>
<span class="sd">            read_fn (Callable): Given the path to a file, returns the datum as</span>
<span class="sd">                a dict.</span>
<span class="sd">            label_fn (Callable): Given the path to a file, returns a dict of</span>
<span class="sd">                labels. If ``label_fn`` returns ``None``, this file is ignored.</span>
<span class="sd">            sort_keys (list): A hierarchy of keys by which the data in this</span>
<span class="sd">                Dataset are sorted.</span>
<span class="sd">            in_memory_keys (list): keys which will be collected from examples</span>
<span class="sd">                when the dataset is cached.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">image_root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">read_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_fn</span> <span class="o">=</span> <span class="n">label_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_keys</span> <span class="o">=</span> <span class="n">sort_keys</span>

        <span class="k">if</span> <span class="n">in_memory_keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_memory_keys</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_memory_keys</span> <span class="o">=</span> <span class="n">in_memory_keys</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_read_labels</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_read_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">operator</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_fn</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">datum</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file_path_&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">}</span>
                    <span class="n">datum</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="p">[</span><span class="n">datum</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_keys</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">datum</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>

<div class="viewcode-block" id="DataFolder.get_example"><a class="viewcode-back" href="../../../docu.html#edflow.data.dataset.DataFolder.get_example">[docs]</a>    <span class="k">def</span> <span class="nf">get_example</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="n">datum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">datum</span><span class="p">[</span><span class="s1">&#39;file_path_&#39;</span><span class="p">]</span>

        <span class="n">file_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">example</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">example</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">datum</span><span class="p">)</span>
        <span class="n">example</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">example</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

    <span class="c1"># r = &#39;/home/johannes/Documents/Uni HD/Dr_J/Projects/data_creation/&#39; \</span>
    <span class="c1">#     &#39;show_vids/cut_selection/fortnite/&#39;</span>

    <span class="c1"># def rfn(im_path):</span>
    <span class="c1">#     return {&#39;image&#39;: plt.imread(im_path)}</span>

    <span class="c1"># def lfn(path):</span>
    <span class="c1">#     if os.path.isfile(path) and path[-4:] == &#39;.jpg&#39;:</span>
    <span class="c1">#         fname = os.path.basename(path)</span>
    <span class="c1">#         labels = fname[:-4].split(&#39;_&#39;)</span>
    <span class="c1">#         if len(labels) == 3:</span>
    <span class="c1">#             pid, act, fid = labels</span>
    <span class="c1">#             beam = False</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             pid, act, _, fid = labels</span>
    <span class="c1">#             beam = True</span>
    <span class="c1">#         return {&#39;pid&#39;: int(pid), &#39;vid&#39;: 0, &#39;fid&#39;: int(fid), &#39;action&#39;: act}</span>

    <span class="c1"># D = DataFolder(r,</span>
    <span class="c1">#                rfn,</span>
    <span class="c1">#                lfn,</span>
    <span class="c1">#                [&#39;pid&#39;, &#39;vid&#39;, &#39;fid&#39;])</span>

    <span class="c1"># for i in range(10):</span>
    <span class="c1">#     d = D[i]</span>
    <span class="c1">#     print(&#39;,\n &#39;.join([&#39;{}: {}&#39;.format(k, v if not hasattr(v, &#39;shape&#39;)</span>
    <span class="c1">#                                        else v.shape)</span>
    <span class="c1">#                                        for k, v in d.items()]))</span>

    <span class="kn">from</span> <span class="nn">edflow.debug</span> <span class="k">import</span> <span class="n">DebugDataset</span>

    <span class="n">D</span> <span class="o">=</span> <span class="n">DebugDataset</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">labels</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;fid&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">ExtraLabelsDataset</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">D</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

    <span class="n">S</span> <span class="o">=</span> <span class="n">SequenceDataset</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

    <span class="n">S</span> <span class="o">=</span> <span class="n">SubDataset</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sub&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">S</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

    <span class="n">U</span> <span class="o">=</span> <span class="n">UnSequenceDataset</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">U</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">seq_len</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">U</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">U</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">EDFlow  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Mimo Tilbich.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.0.
    </div>
  </body>
</html>